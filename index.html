<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡´ä¹–ä¹–çš„æ—¶å…‰èƒ¶å›Š â³</title>
    <style>
        :root {
            --primary-color: #ff758c;
            --secondary-color: #ff7eb3;
            --text-light: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #1a1a2e; color: var(--text-light);
            overflow: hidden; position: fixed; 
        }

        #music-btn {
            position: fixed; top: 20px; right: 20px; z-index: 999;
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer;
        }
        .rotate { animation: rot 3s linear infinite; }
        @keyframes rot { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }

        .swiper-container {
            height: 100%; width: 100%;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex; flex-direction: column;
            will-change: transform;
        }

        .page {
            height: 100vh; width: 100%; flex-shrink: 0;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 60px 20px 40px; position: relative;
        }

        .scroll-area {
            width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding-right: 5px; display: flex; flex-direction: column; align-items: center;
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        .page-1 { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        .page-2 { background: linear-gradient(135deg, #16213e 0%, #2d3436 100%); }
        .page-3 { background: linear-gradient(135deg, #2d3436 0%, #0f3460 100%); }
        .page-4 { background: linear-gradient(135deg, #0f3460 0%, #533483 100%); }
        .dynamic-page { background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%); }
        .page-5 { background: linear-gradient(135deg, #533483 0%, #1a1a2e 100%); }

        .section-title { border-left: 4px solid var(--primary-color); padding-left: 10px; margin-bottom: 20px; align-self: flex-start; flex-shrink: 0; }

        /* --- 4ç§è§†è§‰å·®å¼‚æ˜æ˜¾çš„éšæœºå¡ç‰‡é£æ ¼ --- */
        .unified-card { padding: 18px; margin-bottom: 15px; width: 95%; text-align: left; }
        .unified-card h3 { margin: 0; font-size: 1.1rem; }
        .unified-card small { font-size: 0.7rem; opacity: 0.6; display: block; margin: 5px 0; }
        .unified-card hr { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0; }
        .unified-card p { line-height: 1.6; font-size: 0.95rem; margin: 0; }

        /* é£æ ¼1: æ˜Ÿç©ºæ¯›ç»ç’ƒ - åœ†è§’ */
        .theme-1 { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border-radius: 20px; }
        .theme-1 h3 { color: #ff7eb3; }

        /* é£æ ¼2: å¤å¤ä¿¡çº¸ - ç›´è§’è¾¹æ¡† */
        .theme-2 { background: #fdf6e3; color: #5d4037 !important; border-radius: 2px; border: 2px solid #d3b17d; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); }
        .theme-2 h3 { color: #8d6e63 !important; }
        .theme-2 p, .theme-2 small { color: #5d4037 !important; }
        .theme-2 hr { border-top: 1px solid #d3b17d; }

        /* é£æ ¼3: æ·±è‰²éœ“è™¹ - è™šçº¿è¾¹æ¡† */
        .theme-3 { background: rgba(0, 0, 0, 0.4); border: 1px dashed #00d2d1; border-radius: 15px; box-shadow: 0 0 10px rgba(0, 210, 209, 0.2); }
        .theme-3 h3 { color: #00d2d1 !important; }

        /* é£æ ¼4: æš–é˜³ä¾¿åˆ©è´´ - å€¾æ–œ */
        .theme-4 { background: #fff34d; color: #333 !important; border-radius: 0; transform: rotate(-1.5deg); box-shadow: 5px 5px 10px rgba(0,0,0,0.3); }
        .theme-4 h3 { color: #d63031 !important; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        .theme-4 p, .theme-4 small { color: #333 !important; }
        .theme-4 hr { border-top: 1px solid rgba(0,0,0,0.1); }

        /* åŸæœ‰ç»„ä»¶æ ·å¼ (èƒ¶å›Š1,2,3ä¸“ç”¨) */
        .timeline { border-left: 2px dashed rgba(255,255,255,0.3); padding-left: 20px; width: 100%; }
        .timeline-item { margin-bottom: 20px; }
        .timeline-date { font-size: 0.85rem; color: var(--secondary-color); font-weight: bold; }
        .chat-bubble { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 12px 12px 12px 0; margin-top: 5px; font-size: 0.9rem; }
        .museum-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .museum-card { background: #ffffff; color: #333; padding: 12px; border-radius: 10px; }
        .sticky-wall { width: 100%; }
        .sticky-note { background: #fff34d; color: #333; padding: 15px; margin-bottom: 12px; box-shadow: 5px 5px 7px rgba(0,0,0,0.3); }

        .input-area { width: 100%; max-width: 400px; }
        input, textarea, select { width: 100%; border-radius: 10px; padding: 12px; border: none; margin-bottom: 12px; background: rgba(255,255,255,0.95); font-size: 0.9rem; }
        button { background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.95); }

        .up-arrow { position: absolute; bottom: 20px; animation: updown 2s infinite; font-size: 20px; opacity: 0.6; pointer-events: none; }
        @keyframes updown { 0%,100% {transform:translateY(0)} 50% {transform:translateY(-10px)} }
    </style>
</head>
<body>

    <div id="music-btn" onclick="toggleMusic(event)">ğŸµ
        <audio id="por-una-cabeza" loop preload="auto" src="bgm.mp3"></audio>
    </div>

    <div class="swiper-container" id="swiper">
        <section class="page page-1">
            <h1 style="font-size: 1.8rem; margin-bottom: 10px;">â¤ï¸ è‡´ä¹–ä¹–çš„æ—¶é—´èƒ¶å›Š â¤ï¸</h1>
            <p>ç‚¹å‡»éŸ³ä¹ï¼Œå¼€å¯å›å¿†æ—…ç¨‹</p>
            <div class="up-arrow">â†“</div>
        </section>
        
        <section class="page page-2"><h2 class="section-title">ğŸ’˜ èƒ¶å›Š1ï¼šå¿ƒåŠ¨æ—¶é—´çº¿</h2><div class="scroll-area"><div class="timeline" id="timeline-v1"><div class="timeline-item"><div class="timeline-date">[2025/10/19] ç›¸è¯†æ—¥</div><div class="chat-bubble">"éƒ½åœ¨å»åƒé¥­çš„è·¯ä¸Š"</div></div><div class="timeline-item"><div class="timeline-date">[2025/10/27] åˆè§æ—¥</div><div class="chat-bubble">"æ„Ÿè§‰æœ‰å¸Œæœ›å‘¨æœ«æ‰“ä¹’ä¹“"</div></div><div class="timeline-item"><div class="timeline-date">[2025/10/30] æ·±å¤œdebug</div><div class="chat-bubble">"å’Œä»£ç æ ä¸Šäº†ï¼Œç»ˆäºææ¸…æ¥šé—®é¢˜å‡ºåœ¨å“ªäº†"</div></div><div class="timeline-item"><div class="timeline-date">[2025/11/23] æ•£æ­¥&æ·±åº¦äº¤æµ</div><div class="chat-bubble">"è¿™å®¶å¥½äº† æŒ¨ç€è‹å·æ²³èƒ½é€›é€›"</div></div><div class="timeline-item"><div class="timeline-date">[2026/1/4] å¿ƒåŠ¨ç¡®è®¤</div><div class="chat-bubble">"æˆ‘ç°åœ¨åœ¨ä½“è‚²é¦†ä¹’ä¹“çƒå®¤è¿™ï¼Œä½ æ¥ä¸€ä¸‹å‘—"</div></div></div></div><div class="up-arrow">â†“</div></section>
        <section class="page page-3"><h2 class="section-title">ğŸ›ï¸ èƒ¶å›Š2ï¼šä¸“å±æ¢—åšç‰©é¦†</h2><div class="scroll-area"><div class="museum-grid" id="museum-v2"><div class="museum-card"><h4>ğŸ¦Œ æ¢…èŠ±é¹¿ä¹‹è°œ</h4><p>"ä¸ºå•¥æ˜¯æ¢…èŠ±é¹¿" - æœªè§£ä¹‹è°œ</p></div><div class="museum-card"><h4>ğŸ† çƒŸèŠ±æ‰§å¿µ</h4><p>"æ€ä¹ˆåˆæ˜¯çƒŸèŠ±å“ˆå“ˆå“ˆ" - ç¬¬Nä¸ªè®¡åˆ’</p></div><div class="museum-card"><h4>ğŸ¡ æµ·æ´‹é¦†çº¦å®š</h4><p>"è¿˜æƒ³è·Ÿä½ çœ‹çƒŸèŠ±é€›æµ·æ´‹é¦†å˜"</p></div><div class="museum-card"><h4>ğŸ’ èŠ±è¯­åå¥½</h4><p>"ä½†æˆ‘å–œæ¬¢åŸè‰²èŠ±" - é‡è¦æƒ…æŠ¥</p></div></div></div><div class="up-arrow">â†“</div></section>
        <section class="page page-4"><h2 class="section-title">ğŸŒŸ èƒ¶å›Š3ï¼šæ—¥å¸¸å°ç¡®å¹¸</h2><div class="scroll-area"><div class="sticky-wall" id="sticky-v3"><div class="sticky-note"><strong>ğŸ“ "ä½ ç«Ÿç„¶å¿˜è®°ç»­ç«èŠ±"</strong><small>(2026/2/17)</small></div><div class="sticky-note" style="background: #a29bfe;"><strong>ğŸ“ "æˆ‘æ„Ÿè§‰æˆ‘ä»£ç åƒæ˜¯ä¸Šä¸ªä¸–çºªå†™çš„"</strong><small>(2025/11/6)</small></div><div class="sticky-note" style="background: #fab1a0;"><strong>ğŸ“ "ä¸Šæ¬¡ä½ ç»™æˆ‘è·‘é€šçš„ä»£ç "</strong><small>(2025/12/8)</small></div></div></div><div class="up-arrow">â†“</div></section>

        <div id="dynamic-pages-container" style="display: contents;"></div>

        <section class="page page-5" id="last-page">
            <h2 class="section-title">âœ¨ èƒ¶å›Šå®éªŒå®¤</h2>
            <div class="input-area">
                <select id="capsule-target" onchange="toggleTitleMode()">
                    <option value="new">ğŸ†• åˆ›å»ºå…¨æ–°ç‹¬ç«‹èƒ¶å›Šé¡µ</option>
                    <option value="1">è¡¥å……åˆ°ï¼šğŸ’˜ èƒ¶å›Š1 (æ—¶é—´çº¿)</option>
                    <option value="2">è¡¥å……åˆ°ï¼šğŸ›ï¸ èƒ¶å›Š2 (åšç‰©é¦†)</option>
                    <option value="3">è¡¥å……åˆ°ï¼šğŸŒŸ èƒ¶å›Š3 (ä¾¿åˆ©è´´)</option>
                </select>
                <div id="title-inputs">
                    <input type="text" id="capsule-title" placeholder="æ–°èƒ¶å›Šé¡µ">
                    <input type="text" id="capsule-subtitle" placeholder="å¡ç‰‡æ ‡é¢˜">
                </div>
                <textarea id="capsule-content" placeholder="è®°å½•å½“ä¸‹çš„å¿ƒæƒ…..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveCapsule()" style="flex: 2;">å¯†å°å­˜å…¥</button>
                    <button onclick="clearMemory()" style="flex: 1; background: #666;">é‡ç½®</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        let currentIdx = 0; let total = 5; let startY = 0;
        const container = document.getElementById('swiper');

        // æ»‘åŠ¨æ§åˆ¶é€»è¾‘
        document.addEventListener('touchstart', e => startY = e.touches[0].pageY, { passive: false });
        document.addEventListener('touchmove', e => { if(e.target.closest('.scroll-area')) return; e.preventDefault(); }, { passive: false });
        document.addEventListener('touchend', e => {
            if(e.target.closest('.scroll-area')) return;
            const diff = startY - e.changedTouches[0].pageY;
            if (Math.abs(diff) > 50) {
                if (diff > 0 && currentIdx < total - 1) currentIdx++;
                else if (diff < 0 && currentIdx > 0) currentIdx--;
                container.style.transform = `translateY(-${currentIdx * 100}vh)`;
            }
        }, { passive: false });

        // éŸ³ä¹æ§åˆ¶
        const audio = document.getElementById('por-una-cabeza');
        const btn = document.getElementById('music-btn');
        function toggleMusic(e) { if(e) e.stopPropagation(); if (audio.paused) { audio.play().then(() => btn.classList.add('rotate')); } else { audio.pause(); btn.classList.remove('rotate'); } }

        window.addEventListener('DOMContentLoaded', loadMemory);

        function toggleTitleMode() {
            const target = document.getElementById('capsule-target').value;
            const titleInput = document.getElementById('capsule-title');
            const subtitleInput = document.getElementById('capsule-subtitle');
            if (target === 'new') {
                titleInput.placeholder = "èƒ¶å›Šé¡µåç§°";
                subtitleInput.style.display = 'block';
                subtitleInput.placeholder = "é¦–å¼ å¡ç‰‡æ ‡é¢˜";
            } else {
                titleInput.placeholder = "å¡ç‰‡æ ‡é¢˜";
                subtitleInput.style.display = 'none';
            }
        }

        function saveCapsule() {
            const target = document.getElementById('capsule-target').value;
            const title = document.getElementById('capsule-title').value.trim();
            const subtitle = document.getElementById('capsule-subtitle').value.trim();
            const content = document.getElementById('capsule-content').value.trim();

            if (!content || !title) { alert("æ ‡é¢˜å’Œå†…å®¹éƒ½è¦å†™å“¦~"); return; }

            const timestamp = new Date().toLocaleDateString();
            let memories = JSON.parse(localStorage.getItem("love_capsules_data")) || [];
            
            let themeId;
            if (target === 'new') {
                // æ ¸å¿ƒï¼šæ–°å»ºæ—¶éšæœºåˆ†é…ä¸€ä¸ªä¸»é¢˜ (1-4)
                themeId = Math.floor(Math.random() * 4) + 1;
            } else {
                // æ ¸å¿ƒï¼šè¡¥å……æ—¶å¼ºåˆ¶ç»§æ‰¿è¯¥é¡µé¢çš„ä¸»é¢˜
                const parentPage = memories.find(m => m.id === target && m.isPage);
                themeId = parentPage ? parentPage.themeId : 1;
            }

            const newId = "page_" + Date.now();
            memories.push({
                id: target === 'new' ? newId : target,
                isPage: target === 'new',
                title: title, 
                subtitle: subtitle || "Memory",
                content: content, 
                date: timestamp, 
                targetId: target,
                themeId: themeId // æ ·å¼IDè¢«æ°¸ä¹…é”å®š
            });

            localStorage.setItem("love_capsules_data", JSON.stringify(memories));
            
            // æç¤ºå¹¶é‡è½½
            alert("âœ¨ èƒ¶å›Šå·²å¯†å°ï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ–°æ ·å¼ã€‚");
            location.reload(); 
        }

        function loadMemory() {
            const data = JSON.parse(localStorage.getItem("love_capsules_data")) || [];
            const select = document.getElementById('capsule-target');
            const dynamicContainer = document.getElementById('dynamic-pages-container');
            
            // 1. æ¸²æŸ“ç‹¬ç«‹é¡µ
            const pages = data.filter(item => item.isPage);
            pages.forEach(page => {
                const sec = document.createElement('section');
                sec.className = "page dynamic-page";
                const themeClass = `theme-${page.themeId || 1}`;
                
                sec.innerHTML = `
                    <h2 class="section-title">${page.title}</h2>
                    <div class="scroll-area">
                        <div id="content-${page.id}" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                            <div class="unified-card ${themeClass}">
                                <h3>${page.subtitle}</h3>
                                <small>${page.date}</small>
                                <hr>
                                <p>${page.content}</p>
                            </div>
                        </div>
                    </div>
                    <div class="up-arrow">â†“</div>`;
                dynamicContainer.appendChild(sec);

                // ä¸‹æ‹‰èœå•æ·»åŠ é€‰é¡¹
                const opt = document.createElement('option');
                opt.value = page.id;
                opt.textContent = `è¡¥å……åˆ°ï¼š${page.title}`;
                select.appendChild(opt);
            });

            // 2. æ¸²æŸ“è¡¥å……å†…å®¹
            const updates = data.filter(item => !item.isPage);
            updates.forEach(item => {
                // æ‰¾å‡ºå®ƒåº”è¯¥å‘†åœ¨å“ªä¸ªå®¹å™¨é‡Œ
                const targetBox = document.getElementById(`content-${item.targetId}`);
                if(targetBox) {
                    const div = document.createElement('div');
                    // ç»§æ‰¿ä¿å­˜æ—¶çš„ themeId
                    const themeClass = `theme-${item.themeId || 1}`;
                    div.className = `unified-card dynamic-item ${themeClass}`;
                    div.innerHTML = `<h3>${item.title}</h3><small>${item.date}</small><hr><p>${item.content}</p>`;
                    targetBox.appendChild(div);
                } else {
                    // èƒ¶å›Š1,2,3çš„ç‰¹æ®Šå¤„ç†
                    if (item.targetId === "1") appendItem('timeline-v1', `<div class="timeline-date">[${item.date}] ${item.title}</div><div class="chat-bubble">${item.content}</div>`, "timeline-item");
                    else if (item.targetId === "2") appendItem('museum-v2', `<h4>${item.title}</h4><p>${item.content}</p>`, "museum-card");
                    else if (item.targetId === "3") appendItem('sticky-v3', `<strong>ğŸ“ ${item.title}</strong><small>(${item.date})</small><p style="font-size:0.85rem;">${item.content}</p>`, "sticky-note");
                }
            });

            total = 5 + pages.length;
            toggleTitleMode();
        }

        function appendItem(parentId, html, className) {
            const parent = document.getElementById(parentId); if (!parent) return;
            const div = document.createElement('div'); div.className = "dynamic-item " + className; div.innerHTML = html; parent.appendChild(div);
        }

        function clearMemory() { if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) { localStorage.removeItem("love_capsules_data"); location.reload(); } }
    </script>
</body>
</html>
